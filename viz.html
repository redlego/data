<!doctype html>
<html lang=en>
<meta charset=utf-8>
<head>
</head>
<body>
    <div id=redlego-viz></div>
    
    <script>
        var log10 = Math.log(10),
            countryLookup = {
                sverige: "Sweden",
                deutschland: "Germany",
                schweiz: "Switzerland",
                osterreich: "Austria"
            };
        
        /*
        function sortByAmount(prices){ // TODO: clean up
            var countries = [],
                country, ret = {}, i = 0, len;
                
            for (country in prices){
                if (prices.hasOwnProperty(country)){
                    countries.push({
                        id: country,
                        title: countryName(country),
                        price: prices[country]
                    });
                }
            }
            countries.sort(function(a, b){
                return a.price < b.price;
            });
            len = countries.length;
            
            for (i=0; i<len; i++){
                ret[i] = countries[i];
            }
            return ret;
        }
        */
        
        function upperCaseWords(str){ // from http://phpjs.org/functions/ucwords:569
            return (str + '').replace(/^([a-z])|\s+([a-z])/g, function($1) {
                return $1.toUpperCase();
            });
        }
        
        function countryName(id){
            return countryLookup[id] || upperCaseWords(id.replace("-", " "));
        }
        
        function redlegoViz(data){
            window.onload = function(){
                //data = sortByAmount(data["acrobat-9-pro-extended"].prices);
                data = data["acrobat-9-pro-extended"].prices;
                barChart({
                    data: data,
                    dom: "redlego-viz",
                    xLabelUnit: "$"
                });
           };
        }
    
        function keysvalues(o){
            var keys = [],
                values = [];
                
            for (key in o){
                if (o.hasOwnProperty(key)){
                    keys.push(key);
                    values.push(o[key]);
                }
            }
            return {
                keys: keys,
                values: values
            }
        }
        
        // Returns a number to a certain number of significant figures
        // toPrecision(232, 2) === 230
        // toPrecision(1, 5) === 1; // precision normalised
        function toPrecision(n, precision){
            return Number(parseFloat(n).toPrecision(precision));
        }
        
        function toFixed(n, decimalPlaces){
            return Number(parseFloat(n).toFixed(decimalPlaces));
        }
        
        // idealGradation(9260) === 10000
        function idealGradation(maxValue, idealLabelCount){
            var closestPowerOf10 = Math.pow(10, Math.round(Math.log(maxValue / idealLabelCount) / log10));
            return (maxValue / closestPowerOf10 > idealLabelCount * 2) ?
                closestPowerOf10 * 2 :
                closestPowerOf10;
        }
        
        // humanNumber(4555) === "4.555K";
        // humanNumber(4555, 2) === "4.6K";
        function humanNumber(n, precision){ // TODO: DRY
            n = precision ? toFixed(n, precision) : n;
            
            if (n >= 1000000){
                n = n / 1000000;
                n = (precision ? toFixed(n, precision) : n) + "M";
            }
            if (n >= 1000){
                n = n / 1000;
                n = (precision ? toFixed(n, precision) : n) + "K";
            }
            return n;
        }
    </script>
    
    <script src="js/protovis-d3.2.js"></script>    
    <script type="text/javascript+protovis">        
        function barChart(options){
            var // Options
                data = keysvalues(options.data),
                dom = options.dom,
                xLabelUnit = options.xLabelUnit,
                
                // Chart sizes
                w = 600,
                h = 300,
                yLabelTopPadding = 7,
                yLabelBottomPadding = 5,
                barMargin = 7,
                yLabelWidth = 40,
                yLabelPadding = 7, // where the lines start from
                idealLabelCount = 5,
                yLabelPrecision = 2,
                tooltipPrecision = 2,
                
                // Styles
                fillStyle = "#a00",
                strokeStyle = "#600",
                xLabelStrokeColor = "#d99",
                yLabelColor = "#333",
                xLabelColor = "#fff",
                xLabelFont = "bold 18px sans-serif",
                xLabelStrokeWidth = 0.5,
                barBorderWidth = 0.5,
                // TODO: factor barBorderWidth into width and distribution calculations
                
                // The visualisation object
                vizz = new pv.Panel(),
                
                // Processing
                keys = data.keys,
                values = data.values,
                numValues = values.length,
                maxValue = Math.max.apply(null, values),
                
                // Bar specific
                xDistance = Math.floor((w - yLabelWidth) / numValues) - barMargin,
                visWidth = (xDistance + barMargin) * numValues + yLabelWidth - barMargin, // labels + bars
                
                visHeight = h - yLabelTopPadding - yLabelBottomPadding,
                yLabelGradation = idealGradation(maxValue, idealLabelCount),
                yLabelCount = Math.floor(maxValue / yLabelGradation),
                yLabelMax = yLabelGradation * yLabelCount;
                
            // If precision rounding on yLabelGradation has left the yScale too short, then boost it
            if (yLabelMax < maxValue){
                yLabelMax += yLabelGradation;
            }
                
            vizz
                .canvas(dom)
                .width(w)
                .height(h);
                
            vizz
                .add(pv.Rule)
                    .data(pv.range(0, yLabelMax + yLabelGradation, yLabelGradation))
                    .width(visWidth)
                    .left(yLabelWidth - yLabelPadding)
                    .bottom(function(d) d * (visHeight / yLabelMax) + xLabelStrokeWidth + yLabelBottomPadding)
                    .lineWidth(xLabelStrokeWidth)
                    .strokeStyle(xLabelStrokeColor)
                    
                .add(pv.Label)
                    .left(0)
                    .textStyle(yLabelColor)
                    .text(function(d) xLabelUnit + humanNumber(toFixed(d, yLabelPrecision), 2)) // NOTE: necessary to use yLabelPrecision again, due to JavaScript rounding error- TODO: clean this up
                    .textBaseline("middle");

            var bar = vizz.add(pv.Bar)
                .data(values)
                .width(xDistance)
                .height(function(d) d * (visHeight / yLabelMax) + yLabelBottomPadding)
                .title(function(d) xLabelUnit + humanNumber(toFixed(d, yLabelPrecision), 2))
                .cursor("help")
                .bottom(barBorderWidth + yLabelBottomPadding)
                .left(function() this.index * (xDistance + barMargin) + yLabelWidth)
                .fillStyle(fillStyle)
                .strokeStyle(strokeStyle)
                .lineWidth(barBorderWidth);
            
            bar.add(pv.Label)
                .bottom(barBorderWidth + yLabelBottomPadding + 10)
                .left(function() bar.left() + (xDistance / 2))
                .text(function() countryName(keys[this.index]))
                .textAlign("left")
                .textBaseline("middle")
                .textStyle(xLabelColor)
                .textAngle(-Math.PI / 2)
                .font(xLabelFont);

            vizz.render();
        }
    </script>
    
    <script src="prices.js"></script>
</body>
</html>
